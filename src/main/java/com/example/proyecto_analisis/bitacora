cambios en la base de dato:
1. Agregar autoincrement a idExperienciaLaboral en tablaexperiencia_laboral
2. Cambiar nombre de PK en tabla experiencia laboral de "idExperiencia laboral" a "idExperiencia_laboral"


Pendientes:
1. Agg validacion para que la empresa, idPersona, idPuesto en conjunto no se puedan repetir en tbl idExperiencia_laboral








PROCEDIMIENTO ALMACENADO

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `eliminarPreferenciaSolicitante`(IN `id_solicitante` INT)
BEGIN 

    DELETE FROM preferencias_puestos
    WHERE ID_PERSONA = id_solicitante;
    
    DELETE FROM preferencias_modalidades
    WHERE ID_PERSONA = id_solicitante;
    
    DELETE FROM preferencias_contratos
    WHERE ID_PERSONA = id_solicitante;
    
END$$
DELIMITER ;


DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `eliminarPreferenciasUser`(IN `id_persona` INT)
BEGIN 

    DELETE FROM preferencias_puestos
    WHERE ID_PERSONA = id_persona;
    
    DELETE FROM preferencias_modalidades
    WHERE ID_PERSONA = id_persona;
    
    DELETE FROM preferencias_contratos
    WHERE ID_PERSONA = id_persona;
    
END$$
DELIMITER ;


DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `ingresarFamiliarSolicitante`(
	in idFamiliarP int,
    in idParentescoP int,
    in idSolicitante int
)
BEGIN
	INSERT INTO `familiares`(`ID_FAMILIAR`, `ID_PARENTESCOS`, `ID_SOLICITANTE`) VALUES (idFamiliarP, idParentescoP, idSolicitante);
    
END$$
DELIMITER ;


DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `ingresarHistorialMedico`(
	in descripcionP varchar(300),
    in idCondicionP int,
    in idPersona int
)
BEGIN
	INSERT INTO `historial_medico`(`DESCRIPCION`, `ID_CONDICION_MEDICA`, `ID_PERSONA`) VALUES (descripcionP, idCondicionP, idPersona);
END$$
DELIMITER ;


DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `ingresarPreferenciaContrato`(IN ID_PERSONA_P INT, IN ID_CONTRATO_P INT)
BEGIN
	INSERT INTO preferencias_contratos(ID_PERSONA,ID_CONTRATO) VALUES (ID_PERSONA_P, ID_CONTRATO_P);
END$$
DELIMITER ;


DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `ingresarPreferenciaModalidad`(IN `ID_MODALIDAD_P` INT, IN `ID_PERSONA_P` INT)
BEGIN
	INSERT INTO preferencias_modalidades(ID_MODALIDAD, ID_PERSONA) VALUES (ID_MODALIDAD_P, ID_PERSONA_P);
END$$
DELIMITER ;


DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `ingresarPreferenciaPuesto`(IN `ID_PUESTO_P` INT, IN `ID_PERSONA_P` INT)
BEGIN
	INSERT INTO preferencias_puestos(ID_PUESTO, ID_PERSONA) VALUES (ID_PUESTO_P, ID_PERSONA_P);
END$$
DELIMITER ;


DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `ingresarSolicitanteIdioma`(
	in idPersonaP int,
    in idIdiomaP int,
    in idNivelP int
)
BEGIN
	INSERT INTO `solicitantes_idiomas`(`ID_SOLICITANTE`, `ID_IDIOMA`, `ID_NIVEL_IDIOMA`) VALUES (idPersonaP, idIdiomaP, idNivelP);
END$$
DELIMITER ;


DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `insertarHistorialAcademico`(IN idPersonaP int, in idNivelAcademicoP int, 
                                            in idFormacionAcP int, in tituloP varchar(100), in fechaEgresoP date, 
                                            in INSTITUCIONP varchar(100))
BEGIN
	INSERT INTO `historial_academico`(`ID_PERSONA`, `ID_NIVEL_ACADEMICO`,`ID_FORMACION_PROFESIONAL`, `TITULO`, `FECHA_EGRESO`, `INSTITUCION`) 
    VALUES (idPersonaP, idNivelAcademicoP, idFormacionAcP, tituloP, fechaEgresoP, INSTITUCIONP);
    
END$$
DELIMITER ;


DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `insertarSeguroSolicitante`(
	in idPersonaP int,
    in idTipoSeguroP int,
    in fechaAfiliacionP date,
    in fechaExpiracionP date,
    in numeroAfiliacionP varchar(30)
)
BEGIN
INSERT INTO `seguros_solicitantes`(`ID_PERSONA`, `ID_TIPO_SEGURO`, `FECHA_AFILIACION`, `FECHA_EXPIRACION`, `NUMERO_AFILIACION`) VALUES (idPersonaP, idTipoSeguroP, fechaAfiliacionP, fechaExpiracionP, numeroAfiliacionP);

END$$
DELIMITER ;


//Obtener aplicaciones de solicitante
DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `obtenerAplicacionesSolicitante`(IN `idSolicitanteP` INT)
BEGIN
	SELECT o.id_oferta,
		DATE_FORMAT(o.fecha_publicacion, '%d %b, %Y') as fechaPublicacion,
        o.titulo,
        em.nombre_empresa,
        DATE_FORMAT(s.fecha_solicitud, '%d %b, %Y') as fechaSolicitud,
        es.estado_solicitud,
        em.url_logo
    FROM estado_solicitud es
    INNER JOIN solicitudes s on es.ID_ESTADO_SOLICITUD = s.ID_ESTADO_SOLICITUD
    INNER JOIN ofertas of on s.ID_OFERTA = o.ID_OFERTA
    INNER JOIN empresa em on o.ID_EMPRESA = em.ID_EMPRESA
    WHERE s.ID_SOLICITANTE = idSolicitanteP
    ORDER BY s.FECHA_SOLICITUD ASC;
END$$
DELIMITER ;


//======
//TRIGGER

DELIMITER $$
CREATE TRIGGER TGR_CAMPOS_DEFAULT_OFERTA
BEFORE INSERT ON ofertas
FOR EACH ROW
BEGIN
	IF NEW.FECHA_PUBLICACION IS NULL THEN
    	SET NEW.FECHA_PUBLICACION = CURDATE();
    END IF;
    
    IF NEW.ESTADO_OFERTA IS NULL THEN
    	SET NEW.ESTADO_OFERTA = 1;
    END IF;
    
END $$

DELIMITER ;




//============================
//      SP envia notificacion empresa

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `enviarNotificacionEmpresa`(
    IN ID_PERSONA_P INT, 
    IN ID_OFERTA_P INT,
    IN ID_ESTADO_SOLICITUD_P INT,
    IN ID_SOLICITUD_P INT
)
BEGIN
    DECLARE oferTitulo VARCHAR(255);
    DECLARE idEmpresa INT;
    DECLARE nombreSolicitante VARCHAR(255);

    -- Obtener el nombre completo del solicitante
    SELECT CONCAT(PRIMER_NOMBRE, ' ', PRIMER_APELLIDO) 
    INTO nombreSolicitante
    FROM personas 
    WHERE ID_PERSONA = ID_PERSONA_P;

    -- Obtener el título de la oferta y el ID de la empresa
    SELECT TITULO, ID_EMPRESA 
    INTO oferTitulo, idEmpresa
    FROM ofertas
    WHERE id_oferta = ID_OFERTA_P;

    -- Insertar notificación si el estado de la solicitud es 3
    IF ID_ESTADO_SOLICITUD_P = 3 THEN 
        INSERT INTO notificaciones_empresas (
            TITULO, 
            DESCRIPCION, 
            FECHA, 
            ESTADO_VISUALIZACION, 
            ID_EMPRESA, 
            ID_SOLICITUD
        ) 
        VALUES (
            'SOLICITUD ACEPTADA',
            CONCAT('Nos complace informarle que ', nombreSolicitante, ' ha aceptado la oferta de empleo ', oferTitulo, ' que usted extendió a través de nuestra plataforma. Agradecemos su confianza en nuestra aplicación para facilitar este proceso.'),
            CURDATE(),
            0,
            idEmpresa,
            ID_SOLICITUD_P
        );
    END IF;
    -- si fue rechazada
	IF ID_ESTADO_SOLICITUD_P = 4 THEN 
        INSERT INTO notificaciones_empresas (
            TITULO, 
            DESCRIPCION, 
            FECHA, 
            ESTADO_VISUALIZACION, 
            ID_EMPRESA, 
            ID_SOLICITUD
        ) 
        VALUES (
            'SOLICITUD RECHAZADA',
            CONCAT('Le informamos que ', nombreSolicitante, ' ha decidido rechazar la oferta de empleo ', oferTitulo, ' que usted extendió a través de nuestra plataforma. Agradecemos su confianza en nuestra aplicación para facilitar el proceso.'),
            CURDATE(),
            0,
            idEmpresa,
            ID_SOLICITUD_P
        );
    END IF;

END$$
DELIMITER ;

//===============================
DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `vaciarTablasIntermediasOfertas`(IN idOfertaP int)
BEGIN

	DELETE FROM ofertas_puestos WHERE ID_OFERTA = idOfertaP;
    
    DELETE FROM requisitos_academicos WHERE ID_OFERTA = idOfertaP;
    
    DELETE FROM requisitos_laborales WHERE ID_OFERTA = idOfertaP;
    
    DELETE FROM ofertas_idiomas WHERE ID_OFERTA = idOfertaP;

END$$
DELIMITER ;